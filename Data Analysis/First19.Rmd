---
title: "First 19 Participants"
output: github_document
---
Peek at data to check range of scores and main effect of song condition. Checking range out of concerns regarding variance for alexithymia moderation 


```{r setup, include=TRUE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readbulk)
library(psych)
library(afex)
library(knitr)
library(emmeans)
devtools::install_github("crsh/papaja")
library(sjPlot)
library(irr)
library(tableone)
devtools::install_github("ropenscilabs/gendercodeR")
library(gendercodeR)
```

# Self Report Data 
```{r message = FALSE}
selfreport <- read_csv("First19Data/first19Qual.csv") 
selfreport <- genderRecode(input=selfreport,
                           genderColName = "gender", 
                           method = "narrow",
                           outputColName = "gender_recode", 
                           missingValuesObjectName = NA,
                           customDictionary = data.frame(stringsAsFactors=FALSE,
       Input = c("girl/female"),
      Output = c("female")))

selfreport <- selfreport %>% filter (id < 20)
print(nrow(selfreport))
```

## Describe demographics 
```{r}
selfreport %>% select(age, musichours) %>% describe() %>% kable(digits = 3)
selfreport <- selfreport %>% mutate(yearsplay = as.factor(yearsplay) %>% recode("6" = "5+"))
CreateTableOne(vars = c("gender_recode", "yearsplay"), data = selfreport) %>% kableone()
```

##Create scores 
###Alexithymia
```{r}
selfreport <- selfreport %>% mutate(tas_4r = 6 - .$tas_4, #Reverse code items
                                    tas_5r = 6 - .$tas_5,
                                    tas_10r = 6 - .$tas_10,
                                    tas_18r = 6 - .$tas_18,
                                    tas_19r = 6 - .$tas_19)
EOTlist <- c("tas_5r", "tas_8", "tas_10r", "tas_15", "tas_16", "tas_18r", "tas_19r", "tas_20")
DDFlist <- c("tas_2", "tas_4r", "tas_11", "tas_12", "tas_17")
DIFlist <- c("tas_1", "tas_3", "tas_6", "tas_7", "tas_9", "tas_13", "tas_14")

tas <- selfreport %>% transmute(participant = .$id,
                                EOT = select(., EOTlist) %>% rowSums(),
                                DDF = select(., DDFlist) %>% rowSums(),
                                DIF = select(.,DIFlist) %>% rowSums(),
                                TAS = select(., EOT, DDF, DIF) %>% rowSums())

selfreport %>% select(EOTlist) %>% alpha()
selfreport %>% select(DDFlist) %>% alpha()
selfreport %>% select(DIFlist) %>% alpha()
```

###DASS

```{r}
# S (Stress) Q1, 6, 8, 11, 12, 14, 18
# A (Anxiety) Q2, 4, 7, 9, 15, 19, 20
# D (Depression) Q3, 5, 10, 13, 16, 17, 21 

stresslist <- c("DASS_1", "DASS_6", "DASS_8", "DASS_11", "DASS_12", "DASS_14", "DASS_18")
anxietylist <- c("DASS_2", "DASS_4", "DASS_7", "DASS_9", "DASS_15", "DASS_19", "DASS_20")
depressionlist <- c("DASS_3", "DASS_5", "DASS_10", "DASS_13", "DASS_16", "DASS_17", "DASS_21")

dass <- selfreport %>% transmute(participant = .$id,
                                 stress = select(selfreport, stresslist) %>% rowSums(),
                            anxiety = select(selfreport,anxietylist) %>% rowSums(),
                            depression = select(selfreport,depressionlist) %>% rowSums())

selfreport %>% select(stresslist) %>% alpha()
selfreport %>% select(anxietylist) %>% alpha()
selfreport %>% select(depressionlist) %>% alpha()
```

##Join scores
```{r}
scores <- full_join(dass, tas, by = "participant")
scores %>% select(-participant) %>% describe() %>% kable(digits = 2)
```



#Data Wrangle 
##Load in Data
```{r message = FALSE, warning = FALSE}
raw <- readbulk::read_bulk(directory = "First19Data", fun = read_csv)

raw <- unite(raw, 
             trialunique,
             participant, songmark, songtrials.thisRepN,
             remove = FALSE)

raw <- raw %>% mutate(.,
                      affectcat = as.factor(recode(affectcat,
                                                   "1" = "High Arousal/Positive Valence",
                                                   "2" = "High Arousal/Negative Valence",
                                                   "3" = "Low Arousal/Negative Valence",
                                                   "4" = "Low Arousal/Positve Valence")),
                      arousal = as.factor(recode(arousal, 
                                                 "1" = "Low",
                                                 "2" = "high")),
                      valence = as.factor(recode(valence,
                                                 "1" = "Negative",
                                                 "2" = "Positive")),
                      participant = as.numeric(participant))

#remove practice trial
filtered <- raw %>% filter(!is.na(song) & !(is.na(Instruction)))

filtered <- filtered %>% select(participant,
                                trialunique,
                                Word,
                                songmark,
                                valence,
                                arousal,
                                affectcat,
                                arousalkey.keys,
                                valencekey.keys,
                                likekey.keys,
                                WordResponse.keys) 


```

#Data Wrangling Emotion words 
```{r}
forspread <- filtered %>% filter (WordResponse.keys > 0) %>% select(trialunique,
                                                                    Word,
                                                                    WordResponse.keys)


spread <- forspread %>% spread(key = Word, value = WordResponse.keys)

```

## Affect ratings
```{r}
affectrating <- filtered %>% filter(!is.na(arousalkey.keys)) %>% select(trialunique,
                                                              participant,
                                                              songmark,
                                                              affectcat, 
                                                              valence,
                                                              arousal,
                                                              valencekey.keys,
                                                              arousalkey.keys)
```

##Merge affect and emotion ratings
```{r}
joinedaffectemo <- full_join(affectrating, spread, 
                    by = "trialunique") 
```

##Merge with questioniarre responses 
```{r}
joined <- full_join(joinedaffectemo, scores,
                    by = "participant")
```

# Emotion Differentiation 
## Create list of words
```{r}
poslist <- c("ACTIVE", "ALERT", "EXCITED", "HAPPY", "TENDER") #CHECK ALERT
neglist <- c("ANGRY", "ANXIOUS", "ASHAMED", "FRUSTRATED", "GUILTY", "SAD", "SCARED")
```

# Cretae negative and postive song data sets and participant list 
```{r}
negstim <- joinedaffectemo %>% filter(valence == "Negative")
posstim <- joinedaffectemo %>% filter(valence == "Positive")

participant <- (unique(joinedaffectemo$participant)) 

```

## Negative Stimuli
```{r}
icc_list_negstim=NULL
for(i in participant){
  participant_select <- filter(negstim, participant == i)
  stim_select <- select(participant_select, neglist)
  icc <- irr::icc(stim_select, model = "twoway", unit = "average")
  icc_temp <- icc$value
  fz_iccTemp <- fisherz(icc_temp)
  row_temp <- c(i, icc_temp, fz_iccTemp)
  icc_list_negstim=rbind(icc_list_negstim,row_temp)
  print(icc_temp)
} 

colnames(icc_list_negstim)=c("participant","ICCneg","ICCneg_fz")
icc_list_negstim=as.data.frame(icc_list_negstim)

```

## Positive Stimuli
```{r}
icc_list_posstim=NULL
for(i in participant){
  participant_select <- filter(posstim, participant == i)
  stim_select <- select(participant_select, neglist)
  icc <- irr::icc(stim_select, model = "twoway", unit = "average")
  icc_temp <- icc$value
  fz_iccTemp <- fisherz(icc_temp)
  row_temp <- c(i, icc_temp, fz_iccTemp)
  icc_list_posstim=rbind(icc_list_posstim,row_temp)
  print(icc_temp)
} 

colnames(icc_list_posstim)=c("participant","ICCpos","ICCpos_fz")
icc_list_posstim=as.data.frame(icc_list_posstim)
```

#Join ICC, make values inverse and mark negative (negative scores cannot be interpreted)
```{r}
joinedICC <- full_join(icc_list_posstim, icc_list_negstim, by = "participant")  %>% full_join(scores, by = "participant")

joinedICC <- joinedICC %>% mutate (ICCneg_keep = if_else(condition = .$ICCneg > 0,
                                                          true = "Positive",
                                                          false = "Ignore",
                                                          missing = "Ignore"),
                                    ICCpos_keep = if_else(condition = .$ICCpos > 0,
                                                          true = "Positive",
                                                          false = "Ignore",
                                                          missing = "Ignore"),
                                    ICCneg_r = 1 - .$ICCneg,
                                    ICCneg_fz_r = -1* .$ICCneg.fz,
                                    ICCpos_r = 1 - .$ICCpos,
                                    ICCpos_fz_r = -1* .$ICCpos.fz)  
```


<!-- # Load in data  -->
<!-- ```{r message = FALSE, warning = FALSE} -->
<!-- first19 <- readbulk::read_bulk(directory = "First19Data", fun = read_csv) -->

<!-- first19 <- unite(first19,  -->
<!--                  trialunique, -->
<!--                  participant, songmark, songtrials.thisRepN, -->
<!--                  remove = FALSE) -->

<!-- first19 <- first19 %>% mutate(., -->
<!--                               affectcat = as.factor(recode(affectcat, -->
<!--                                                            "1" = "High Arousal/Positive Valence", -->
<!--                                                            "2" = "High Arousal/Negative Valence", -->
<!--                                                            "3" = "Low Arousal/Negative Valence", -->
<!--                                                            "4" = "Low Arousal/Positve Valence")), -->
<!--                               arousal = as.factor(recode(arousal,  -->
<!--                                                          "1" = "Low", -->
<!--                                                          "2" = "high")), -->
<!--                               valence = as.factor(recode(valence, -->
<!--                                                          "1" = "Negative", -->
<!--                                                          "2" = "Positive"))) -->




<!-- ``` -->

<!-- ```{r} -->
<!-- head(first19) -->
<!-- #remove practice trial -->
<!-- filtered19 <- first19 %>% filter(valencekey.keys > 0 & arousalkey.keys > 0 & songmark > 0) -->

<!-- filtered19 <- filtered19 %>% select(participant, -->
<!--                                     id_trial, -->
<!--                                     Word, -->
<!--                                     songmark, -->
<!--                                     valence, -->
<!--                                     arousal, -->
<!--                                     affectcat, -->
<!--                                     arousalkey.keys, -->
<!--                                     valencekey.keys, -->
<!--                                     likekey.keys, -->
<!--                                     WordResponse.keys)  -->

<!-- names(filtered19) -->

<!-- filtered19 %>% select(arousalkey.keys, valencekey.keys, likekey.keys) %>% describeBy(group = filtered19$affectcat)  -->
<!-- ``` -->

<!-- #Data Wrangling Emotion words  -->
<!-- ```{r} -->
<!-- forspread <- first19 %>% filter (WordResponse.keys > 0) %>% select(trialunique, -->
<!--                                 Word, -->
<!--                                 WordResponse.keys) -->


<!-- spread <- forspread %>% group_by (trialunique) %>% spread(key = Word, value = WordResponse.keys) -->

<!-- ``` -->

<!-- #Bind affect rating with emotion rating  -->

<!-- ```{r} -->
<!-- affectrating <- first19 %>% filter(valencekey.keys > 0 & songmark > 0) %>% select(trialunique, -->
<!--                                                                    participant, -->
<!--                                                                    songmark, -->
<!--                                                                    affectcat,  -->
<!--                                                                    valence, -->
<!--                                                                    arousal, -->
<!--                                                                    valencekey.keys, -->
<!--                                                                    arousalkey.keys) -->

<!-- names(c(affectrating, spread19)) -->
<!-- joined <- full_join(affectrating, spread19,  -->
<!--                     by = "trialunique") -->


<!-- View(joined) -->
<!-- ``` -->







<!-- ```{r} -->
<!-- # #require(ggplot2)     -->
<!-- # p <- ggplot(data = df, aes(x=hour))  -->
<!-- # p <- p + geom_histogram(aes(weights=count, fill=weekday)) -->
<!-- # p <- p + scale_fill_brewer(palette="Set3") -->
<!-- # p <- p + facet_wrap( ~ weekday, ncol=1) -->
<!-- # p -->

<!-- filtered19 %>% ggplot(aes(x=valencekey.keys)) + geom_histogram(binwidth = .5)  +facet_wrap(~affectcat) -->

<!-- filtered19 %>% ggplot(aes(x=arousalkey.keys)) + geom_histogram(binwidth = .5) +facet_wrap(~affectcat) -->

<!-- filtered19 %>% ggplot(aes(x=likekey.keys)) + geom_histogram(binwidth = .5) +facet_wrap(~affectcat) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- names(filtered19) -->

<!-- filtered19 <- filtered19 %>% select(affectcat, -->
<!--                                     valence, -->
<!--                                     arousal, -->
<!--                                     songmark, -->
<!--                                     valencekey.keys, -->
<!--                                     arousalkey.keys, -->
<!--                                     likekey.keys, -->
<!--                                     participant) -->

<!-- pilotmodelvalence <- afex::mixed(formula = valencekey.keys~affectcat + (1 |songmark) +(affectcat |participant), data = filtered19, return = "merMod")  -->

<!-- valenceplot <- plot_model(pilotmodelvalence, type = "eff") -->
<!-- print(valenceplot$affectcat) -->

<!-- emmeans(pilotmodelvalence, "affectcat") %>% pairs() %>% kable(caption = "Pairwise comparisons of main effect of song affect category for valence ratings", digits = 3)  -->

<!-- pilotmodelarousal <- afex::mixed(formula = arousalkey.keys~affectcat + (1 |participant), data = filtered19, return = "merMod")  -->

<!-- arousalplot <- plot_model(pilotmodelarousal, type = "eff") -->
<!-- print(arousalplot$affectcat) -->

<!-- emmeans(pilotmodelarousal, "affectcat") %>% pairs() %>% kable(caption = "Pairwise comparisons of main effect of song affect category for arousal ratings", digits = 0) -->
<!-- ``` -->

<!-- #Data Wrangling Emotion words  -->
<!-- ```{r} -->
<!-- forspread <- first19 %>% filter (WordResponse.keys > 0) %>% select(trialunique, -->
<!--                                 Word, -->
<!--                                 WordResponse.keys) -->


<!-- spread19 <- forspread %>% group_by (trialunique) %>% spread(key = Word, value = WordResponse.keys) -->

<!-- ``` -->


<!-- #Emotion differentiation -->
<!-- ## Negative stimuli  -->

<!-- negstim <- joined %>% filter(valence == "Negative") -->
<!-- ```{r} -->
<!-- negstim <- joined %>% filter(valence == "Negative") -->

<!-- PID <-  unique(joined$participant) -->

<!-- negICC=NULL -->
<!-- for (sub in PID){ -->
<!--  sub_negstim=negstim[negstim[,1]==sub,c("ANGRY", "ANXIOUS", "ASHAMED", "FRUSTRATED", "GUILTY", "SAD", "SCARED")]  #selects data for the current subject -->
<!--   icc=icc(sub_negstim, model="twoway",unit="average")  #computes ICC -->
<!--   icc_temp=icc$value -->

<!--   fz_iccTemp=fisherz(icc_temp) -->

<!--   row_temp=c(sub,icc_temp,fz_iccTemp) -->
<!--   icc_list_negstim=rbind(icc_list_negstim,row_temp) -->
<!--   print(fz_iccTemp) -->
<!-- } -->

<!-- colnames(icc_list_w1)=c("Participant","ICCneg","ICCneg.fz") -->
<!-- icc_list_negstim=as.data.frame(icc_list_negstim) -->


<!-- colnames(icc_list_negstim)=c("PpID","ICCneg","ICCneg.fz") -->
<!-- icc_list_w1=as.data.frame(icc_list_negstim) -->

<!-- ``` -->


```{r}
pilotmodelvalence <- afex::mixed(formula = valencekey.keys~affectcat + (1 |songmark) +(affectcat |participant), data = filtered, return = "merMod")  

valenceplot <- plot_model(pilotmodelvalence, type = "eff") 
print(valenceplot$affectcat)

emmeans(pilotmodelvalence, "affectcat") %>% pairs() %>% kable(caption = "Pairwise comparisons of main effect of song affect category for valence ratings", digits = 3)

```



